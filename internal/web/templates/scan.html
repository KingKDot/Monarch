<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monarch</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script>
    function isTerminal(s) { return s==='clean'||s==='malware'||s==='error'; }
    function dotClass(s) {
      s = (s||'').toLowerCase();
      if (s==='malware'||s==='error') return 'dot dot-malware';
      if (s==='clean')   return 'dot dot-clean';
      if (s==='scanning'||s==='pending') return 'dot dot-scanning';
      return 'dot dot-queued';
    }
    function badgeClass(s) {
      s = (s||'').toLowerCase();
      if (s==='malware'||s==='error') return 'badge badge-malware';
      if (s==='clean')   return 'badge badge-clean';
      if (s==='scanning') return 'badge badge-scanning';
      if (s==='pending')  return 'badge badge-pending';
      return 'badge badge-queued';
    }
    function rowClass(s) {
      s = (s||'').toLowerCase();
      if (s==='malware') return 'row-malware';
      if (s==='clean')   return 'row-clean';
      if (s==='error')   return 'row-error';
      return '';
    }
    function resultLabel(s) {
      s = (s||'').toLowerCase();
      if (s==='malware') return 'Detected';
      if (s==='clean')   return 'Undetected';
      if (s==='error')   return 'Scan failed';
      if (s==='scanning') return 'Scanning';
      if (s==='queued')   return 'Queued';
      return s || 'Unknown';
    }
    function formatLocalTime(iso) {
      if (!iso) return '';
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return (iso || '').replace('T',' ').slice(0,19);
      return dt.toLocaleString();
    }
    function renderResults(results) {
      const body = document.getElementById('results-body');
      if (!body) return;
      body.innerHTML = '';
      for (const r of results||[]) {
        const tr = document.createElement('tr');
        tr.className = rowClass(r.status);

        const tdName = document.createElement('td');
        tdName.className = 'td-name';
        tdName.textContent = (r.av || '');

        const tdStatus = document.createElement('td');
        const sp = document.createElement('span');
        sp.className = badgeClass(r.status);
        sp.textContent = resultLabel(r.status);
        tdStatus.appendChild(sp);

        const tdDet = document.createElement('td');
        tdDet.className = 'td-name';
        tdDet.textContent = (r.detection || '\u2014');

        const tdDel = document.createElement('td');
        tdDel.textContent = (r.deleted == null ? '\u2014' : String(r.deleted));

        const tdUpd = document.createElement('td');
        tdUpd.className = 'td-dim';
        tdUpd.textContent = formatLocalTime(r.updated_at);

        tr.appendChild(tdName);
        tr.appendChild(tdStatus);
        tr.appendChild(tdDet);
        tr.appendChild(tdDel);
        tr.appendChild(tdUpd);
        body.appendChild(tr);
      }
    }
    function setTopbar(visible) {
      const tb = document.getElementById('m-topbar');
      if (!tb) return;
      if (visible) tb.classList.remove('done');
      else tb.classList.add('done');
    }
    async function pollScan(id) {
      try {
        const res = await fetch('/api/scan/' + id, {cache:'no-store'});
        if (!res.ok) return;
        const data = await res.json();
        const badge = document.getElementById('scan-status');
        const dot   = document.getElementById('scan-dot');
        const detEl = document.getElementById('detected-count');
        const engEl = document.getElementById('engine-count');
        if (badge && data.status) { badge.textContent = data.status; badge.className = badgeClass(data.status); }
        if (dot   && data.status) { dot.className = dotClass(data.status); }
        if (data.results) {
          renderResults(data.results);
          if (detEl && engEl) {
            let detected = 0;
            for (const r of data.results) {
              if ((r.status || '').toLowerCase() === 'malware') detected++;
            }
            detEl.textContent = String(detected);
            engEl.textContent = String(data.results.length);
          }
        }
        if (isTerminal(data.status)) {
          clearInterval(window.__poll);
          setTopbar(false);
          const msg = document.getElementById('scan-msg');
          if (msg) msg.style.display = 'none';
        }
      } catch(e) {}
    }
    function startPolling(id) {
      setTopbar(true);
      pollScan(id);
      window.__poll = setInterval(() => pollScan(id), 1000);
    }
  </script>
</head>
<body>

<div id="m-topbar"><div id="m-topbar-inner"></div></div>

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      Monarch
    </a>
    <div class="nav-links">
      <a href="/api/scan/{{.ScanID}}" class="nav-link">JSON</a>
      <a href="/" class="nav-link">Home</a>
    </div>
  </div>
</nav>

<main class="main scan-page">

  <div class="card fade scan-panel">
    <div class="card-header">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      Scan result
    </div>
    <div class="card-body" style="display:flex; flex-direction:column; gap:0.6rem;">
      <div style="display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap;">
        <span id="scan-dot" class="{{if eq .Status "clean"}}dot dot-clean{{else if eq .Status "malware"}}dot dot-malware{{else if eq .Status "error"}}dot dot-error{{else}}dot dot-scanning{{end}}"></span>
        <span id="scan-status" class="{{if eq .Status "clean"}}badge badge-clean{{else if eq .Status "malware"}}badge badge-malware{{else if eq .Status "error"}}badge badge-error{{else if eq .Status "scanning"}}badge badge-scanning{{else}}badge badge-pending{{end}}">{{.Status}}</span>
        <span class="text-muted">Detected by <strong id="detected-count" style="color:#e4e4e7;">{{.DetectedCount}}</strong> / <strong id="engine-count" style="color:#e4e4e7;">{{.EngineCount}}</strong> engine(s)</span>
      </div>
      <div style="font-size:1rem; font-weight:600; color:#e4e4e7;">{{.Filename}}</div>
      <div class="mono text-muted" style="font-size:0.72rem;">{{.SHA256}}</div>
    </div>
  </div>

  <div class="card fade scan-panel">
    <div class="card-header">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      AV Results
    </div>
    <div class="results-scroll panel-scroll">
      <table class="data-table">
        <thead>
          <tr>
            <th>Engine</th>
            <th>Result</th>
            <th>Detection</th>
            <th>Deleted</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="results-body">
          {{range .Results}}
          <tr class="{{if eq .Status "malware"}}row-malware{{else if eq .Status "clean"}}row-clean{{else if eq .Status "error"}}row-error{{end}}">
            <td class="td-name">{{.AV}}</td>
            <td>
              <span class="{{if eq .Status "malware"}}badge badge-malware{{else if eq .Status "clean"}}badge badge-clean{{else if eq .Status "error"}}badge badge-error{{else if eq .Status "scanning"}}badge badge-scanning{{else}}badge badge-default{{end}}">
                {{if eq .Status "malware"}}Detected{{else if eq .Status "clean"}}Undetected{{else if eq .Status "error"}}Scan failed{{else if eq .Status "scanning"}}Scanning{{else if eq .Status "queued"}}Queued{{else}}{{.Status}}{{end}}
              </span>
            </td>
            <td class="td-name">{{if .Detection}}{{.Detection}}{{else}}&mdash;{{end}}</td>
            <td>{{if .Deleted}}{{.Deleted}}{{else}}&mdash;{{end}}</td>
            <td class="td-dim">{{.Updated}}</td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card fade scan-panel">
    <div class="card-header">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/></svg>
      File details
    </div>
    <div class="details-scroll panel-scroll">
      <table class="data-table details-table">
        <tbody>
          <tr><th>File name</th><td class="td-name">{{.Filename}}</td></tr>
          <tr><th>File size</th><td class="td-mono">{{.FileSize}} bytes</td></tr>
          <tr><th>Analysis date</th><td class="td-dim">{{.CreatedAt.Format "2006-01-02 | 15:04:05"}}</td></tr>
          <tr><th>CRC32</th><td class="td-mono">{{if .CRC32}}{{.CRC32}}{{else}}N/A{{end}}</td></tr>
          <tr><th>MD5</th><td class="td-mono">{{if .MD5}}{{.MD5}}{{else}}N/A{{end}}</td></tr>
          <tr><th>SHA-1</th><td class="td-mono">{{if .SHA1}}{{.SHA1}}{{else}}N/A{{end}}</td></tr>
          <tr><th>SHA-2</th><td class="td-mono">{{.SHA256}}</td></tr>
          <tr><th>SSDEEP</th><td class="td-mono">{{if .SSDEEP}}{{.SSDEEP}}{{else}}N/A{{end}}</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  {{if and (ne .Status "clean") (ne .Status "malware") (ne .Status "error")}}
  <div id="scan-msg" class="scan-banner fade">
    <span class="spinner"></span>
    <div>
      <div class="scan-banner-text">Scan in progress</div>
      <div class="scan-banner-sub">Results update automatically</div>
    </div>
  </div>
  {{end}}

</main>

<script>
  const _s = '{{.Status}}';
  if (isTerminal(_s)) setTopbar(false);
  else startPolling('{{.ScanID}}');
</script>
</body>
</html>
