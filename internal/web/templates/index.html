<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monarch</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  {{if .ChartData}}<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>{{end}}
  <script>
    const MAX_UPLOAD_BYTES = 35 * 1024 * 1024;

    function bindCaptchaClicks(prefix, count) {
      const master = document.getElementById(prefix + '_captcha_master');
      const solEl  = document.getElementById(prefix + '_captcha_solution');
      const hintEl = document.getElementById(prefix + '_captcha_hint');
      if (!master || !solEl) return;

      const state = { points: [], count: (count || 0) };
      solEl.value = '[]';
      if (hintEl) hintEl.textContent = 'Clicks: 0 / ' + state.count;

      master.onclick = (ev) => {
        if (state.count <= 0) return;
        if (state.points.length >= state.count) return;
        const rect = master.getBoundingClientRect();
        const rx = (ev.clientX - rect.left) / rect.width;
        const ry = (ev.clientY - rect.top) / rect.height;
        const nw = master.naturalWidth || rect.width;
        const nh = master.naturalHeight || rect.height;
        const x = Math.max(0, Math.min(Math.round(rx * nw), Math.round(nw)));
        const y = Math.max(0, Math.min(Math.round(ry * nh), Math.round(nh)));
        state.points.push({x, y});
        solEl.value = JSON.stringify(state.points);
        if (hintEl) hintEl.textContent = 'Clicks: ' + state.points.length + ' / ' + state.count;
      };
    }

    async function loadCaptcha(prefix) {
      const res = await fetch('/captcha/new', { cache: 'no-store' });
      const data = await res.json();
      document.getElementById(prefix + '_captcha_id').value = data.id;
      document.getElementById(prefix + '_captcha_solution').value = '[]';
      document.getElementById(prefix + '_captcha_thumb').src = data.thumb_url;
      document.getElementById(prefix + '_captcha_master').src = data.master_url;
      bindCaptchaClicks(prefix, data.count);
    }

    function setupDrop(zoneId) {
      const zone = document.getElementById(zoneId);
      if (!zone) return;
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('drag-over');
        const inp = zone.querySelector('input[type=file]');
        if (inp && e.dataTransfer.files.length) {
          inp.files = e.dataTransfer.files;
          updateLabel(inp);
        }
      });
      const inp = zone.querySelector('input[type=file]');
      if (inp) inp.addEventListener('change', () => updateLabel(inp));
    }

    function updateLabel(inp) {
      const lbl = document.getElementById('drop-label');
      if (lbl && inp.files.length) lbl.textContent = inp.files[0].name;
    }

    function showUploadError(msg) {
      const err = document.getElementById('upload-error');
      if (!err) return;
      if (msg) {
        err.textContent = msg;
        err.style.display = 'flex';
      } else {
        err.textContent = '';
        err.style.display = 'none';
      }
    }

    function validateFileSize(inp) {
      if (!inp || !inp.files || !inp.files.length) return true;
      const size = inp.files[0].size || 0;
      if (size > MAX_UPLOAD_BYTES) {
        const mb = (size / (1024 * 1024)).toFixed(1);
        showUploadError('File is too large (' + mb + ' MB). Max is 35 MB.');
        return false;
      }
      showUploadError('');
      return true;
    }

    function setupUpload() {
      const form = document.getElementById('scan-form');
      if (!form) return;
      const inp = form.querySelector('input[type=file]');
      if (inp) inp.addEventListener('change', () => validateFileSize(inp));
      form.addEventListener('submit', e => {
        e.preventDefault();
        if (inp && !validateFileSize(inp)) return;
        const btn = document.getElementById('scan-btn');
        const prog = document.getElementById('upload-progress');
        const bar  = document.getElementById('upload-progress-bar');
        const lbl  = document.getElementById('upload-progress-label');

        btn.disabled = true;
        btn.textContent = 'Uploading…';
        prog.style.display = 'block';

        const xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('progress', ev => {
          if (ev.lengthComputable) {
            const pct = Math.round(ev.loaded / ev.total * 100);
            bar.style.width = pct + '%';
            lbl.textContent = pct + '%';
          }
        });
        xhr.addEventListener('load', () => {
          bar.style.width = '100%';
          if (xhr.status < 400 && xhr.responseURL) {
            window.location.href = xhr.responseURL;
          } else {
            btn.disabled = false;
            btn.textContent = 'Scan file';
            prog.style.display = 'none';
            lbl.textContent = 'Upload failed — try again';
            lbl.style.color = '#fca5a5';
            prog.style.display = 'block';
          }
        });
        xhr.addEventListener('error', () => {
          btn.disabled = false;
          btn.textContent = 'Scan file';
          prog.style.display = 'none';
        });
        xhr.open('POST', '/scan');
        xhr.send(new FormData(form));
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      setupDrop('drop-zone');
      setupUpload();
    });

    const consoleimg = {
      load: function(e, {size: o=320, color: n="transparent"}={}) {
        const t = new FileReader;
        t.addEventListener("load", function() {
          const e = "background: url('" + t.result + "') left top no-repeat; font-size: " + o + "px; background-size: contain; background-color:" + n;
          console.log("%c     ", e)
        }, !1),
        fetch(e).then(e => e.blob()).then(e => {
          if (0 === e.type.indexOf("image")) {
            if (e.size > 8192 && navigator.userAgent.indexOf("Firefox") > 0)
              throw new Error("Image size too big to be displayed in Firefox.");
            return e
          }
          throw new Error("Valid image not found.")
        }
        ).then(e => t.readAsDataURL(e)).catch(e => console.warn(e.message))
      }
    };

    // Fun console easter egg (served same-origin to avoid CORS)
    consoleimg.load('/static/console.gif', { size: 320, color: 'transparent' });
  </script>
</head>
<body>

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      Monarch
    </a>
    <div class="nav-links">
      {{if .AccountID}}
        <span class="nav-link" style="opacity:0.85; cursor:default; user-select:all;">
          Account ID: <span style="font-variant-numeric:tabular-nums;">{{.AccountID}}</span>
        </span>
        <form method="post" action="/logout" style="display:contents;">
          <button type="submit" class="nav-link">Logout</button>
        </form>
      {{else}}
        <a href="/signup" class="nav-link">Sign up</a>
        <a href="/login" class="btn btn-primary" style="font-size:0.8rem; padding:0.35rem 0.9rem;">Login</a>
      {{end}}
    </div>
  </div>
</nav>

<main class="main main-home">

  {{if .Error}}
  <div class="alert-error fade">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    {{.Error}}
  </div>
  {{end}}

  {{if .AccountID}}
  {{if .ChartData}}
  <div class="card fade insights-card" style="overflow:hidden;">
    <div class="card-header">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M19 9l-5 5-4-4-3 3"/></svg>
      Usage insights (last 30 days)
    </div>
    <div class="card-body">
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-title">Daily scans</div>
          <canvas id="chart-scans" class="chart-canvas" width="420" height="120"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">New users</div>
          <canvas id="chart-users" class="chart-canvas" width="420" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
  {{end}}

  <div class="home-grid">

    {{/* ── Upload form ── */}}
    <div class="card fade scan-card">
      <div class="card-header">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></svg>
        Scan a file
      </div>
      <div class="card-body scan-card-body">
        <p class="text-muted text-small" style="margin-bottom:1.25rem;">Submit a file to scan across your AV environments. Max 35 MB.</p>
        <form id="scan-form" class="scan-form" method="post" action="/scan" enctype="multipart/form-data">
          <div class="form-group" style="margin-bottom:0.9rem;">
            <div class="form-label" style="margin-bottom:0.5rem;">Mode</div>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              <label class="nav-link" style="gap:0.45rem; cursor:pointer;">
                <input type="radio" name="mode" value="scantime" checked />
                Scan time
              </label>
              <label class="nav-link" style="gap:0.45rem; opacity:0.55; cursor:not-allowed;">
                <input type="radio" name="mode" value="runtime" disabled />
                Runtime (coming soon)
              </label>
            </div>
          </div>
          <div class="drop-zone scan-drop-zone" id="drop-zone" style="margin-bottom:1rem;">
            <input type="file" name="file" required />
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2a2a38" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:block;margin:0 auto 0.6rem;"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></svg>
            <div class="drop-label" id="drop-label">Drop a file or click to browse</div>
            <div class="drop-hint">Any file type · up to 35 MB</div>
          </div>
          <div id="upload-error" class="alert-error" style="display:none; margin-bottom:1rem;"></div>
          <div class="upload-progress" id="upload-progress">
            <div class="upload-progress-track">
              <div class="upload-progress-bar" id="upload-progress-bar"></div>
            </div>
            <div class="upload-progress-label" id="upload-progress-label">Uploading…</div>
          </div>
          {{if .RequireCaptcha}}
          <input type="hidden" id="scan_captcha_id" name="captcha_id" />
          <div style="margin-bottom:1rem;">
            <div class="form-label" style="margin-bottom:0.5rem;">Captcha</div>
            <input type="hidden" id="scan_captcha_solution" name="captcha_solution" />
            <div class="captcha-row" style="align-items:flex-start;">
              <div style="display:flex; flex-direction:column; gap:0.35rem;">
                <img id="scan_captcha_thumb" class="captcha-img" alt="captcha challenge" />
                <div id="scan_captcha_hint" class="text-muted text-small">Clicks: 0 / 0</div>
              </div>
              <button type="button" class="btn btn-ghost" onclick="loadCaptcha('scan')" style="font-size:0.78rem; padding:0.35rem 0.75rem;">Refresh</button>
            </div>
            <div style="margin-top:0.6rem;">
              <img id="scan_captcha_master" class="captcha-img" alt="captcha image" style="width:100%; max-width:320px; height:auto; cursor:crosshair;" />
            </div>
          </div>
          {{end}}
          <button type="submit" id="scan-btn" class="btn btn-primary btn-full" style="margin-top:0.75rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Scan file
          </button>
        </form>
        {{if .RequireCaptcha}}<script>loadCaptcha('scan');</script>{{end}}
      </div>
    </div>

    {{/* ── Recent scans ── */}}
    <div id="recent-scans-card" class="card fade recent-scans-card" style="overflow:hidden;" hx-get="/partials/recent-scans" hx-trigger="every 15s" hx-swap="innerHTML">
      {{template "partials_recent_scans.html" .}}
    </div>

  </div>
  {{else}}
  <div class="hero fade">
    <div class="hero-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
    </div>
    <h1>Monarch</h1>
    <p>File scanning across isolated AV environments.</p>
    <div class="hero-actions">
      <a href="/login" class="btn btn-primary">Login</a>
      <a href="/signup" class="btn btn-ghost">Create account</a>
    </div>
  </div>
  {{end}}

</main>

{{if .ChartData}}
<script>
  const chartData = {{.ChartData}};
  if (window.Chart && chartData) {
    const axisColor = '#3f3f46';
    const gridColor = 'rgba(255,255,255,0.04)';
    const labelColor = '#a1a1aa';

    const scansCtx = document.getElementById('chart-scans');
    if (scansCtx) {
      new Chart(scansCtx, {
        type: 'line',
        data: {
          labels: chartData.labels || [],
          datasets: [{
            label: 'Scans',
            data: chartData.scanCounts || [],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.12)',
            tension: 0.35,
            fill: true,
            pointRadius: 0,
            borderWidth: 2
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          layout: { padding: { left: 4, right: 12 } },
          plugins: { legend: { display: false } },
          scales: {
            x: { offset: true, ticks: { color: labelColor, padding: 6 }, grid: { color: gridColor } },
            y: { ticks: { color: labelColor }, grid: { color: gridColor } }
          }
        }
      });
    }

    const usersCtx = document.getElementById('chart-users');
    if (usersCtx) {
      new Chart(usersCtx, {
        type: 'bar',
        data: {
          labels: chartData.labels || [],
          datasets: [{
            label: 'New users',
            data: chartData.userCounts || [],
            backgroundColor: 'rgba(34,197,94,0.25)',
            borderColor: '#22c55e',
            borderWidth: 1
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          layout: { padding: { left: 4, right: 12 } },
          plugins: { legend: { display: false } },
          scales: {
            x: { offset: true, ticks: { color: labelColor, maxRotation: 0, minRotation: 0, padding: 6 }, grid: { color: gridColor } },
            y: { ticks: { color: labelColor }, grid: { color: gridColor } }
          }
        }
      });
    }

  }
</script>
{{end}}
</body>
</html>
